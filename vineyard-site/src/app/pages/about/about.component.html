<ng-container *ngIf="isAdmin">
  <div class="w-full mt-5 border-b border-gray-200 pb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="text-xs text-gray-600">
      <ng-container *ngIf="autosaveState$ | async as autosave">
        <span *ngIf="autosave.status === 'dirty'">Unsaved changes</span>
        <span *ngIf="autosave.status === 'saving'">Saving...</span>
        <span *ngIf="autosave.status === 'saved'">
          Draft saved<span *ngIf="autosave.lastSavedUtc"> at {{ autosave.lastSavedUtc | date: 'HH:mm' }}</span>
        </span>
        <span *ngIf="autosave.status === 'error'">Autosave failed</span>
      </ng-container>
      <span *ngIf="hasDraft" class="ml-2 text-gray-500">Draft loaded</span>
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <label class="text-sm text-gray-700 flex items-center gap-2">
        <span class="text-xs uppercase tracking-wide text-gray-500">Version</span>
        <select
          class="border border-gray-300 rounded px-2 py-1 text-sm"
          [ngModel]="selectedVersionId || ''"
          (ngModelChange)="onVersionChange($event)">
          <option *ngIf="hasDraft" value="draft">Draft</option>
          <option value="">
            Current (Live<ng-container *ngIf="liveVersionNo"> v{{ liveVersionNo }}</ng-container>)
          </option>
          <option *ngFor="let v of versions" [value]="v.id">
            v{{ v.versionNo }}<ng-container *ngIf="v.versionNo === liveVersionNo"> (live)</ng-container> - {{ v.publishedUtc | date: 'dd/MM/yyyy HH:mm' }}<ng-container *ngIf="v.changeNote"> - {{ v.changeNote }}</ng-container>
          </option>
        </select>
      </label>
      <ng-container *ngIf="isPreviewing && selectedVersionId; else liveActions">
        <button
          type="button"
          class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded disabled:opacity-50"
          [disabled]="isReverting"
          (click)="revertToSelectedVersion()">
          {{ isReverting ? 'Reverting...' : ('Revert to v' + (previewVersionNo ?? '?')) }}
        </button>
      </ng-container>
      <ng-template #liveActions>
        <button
          *ngIf="hasDraft"
          type="button"
          class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded disabled:opacity-50"
          [disabled]="isPublishing"
          (click)="publishDraft()">
          {{ isPublishing ? 'Publishing...' : 'Publish draft' }}
        </button>
        <button
          *ngIf="hasDraft"
          type="button"
          class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded disabled:opacity-50"
          [disabled]="isPublishing"
          (click)="discardDraft()">
          Discard draft
        </button>
        <button
          type="button"
          class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition"
          (click)="togglePreview()">
          {{ isPreviewing ? 'Edit' : 'Preview' }}
        </button>
      </ng-template>
    </div>
  </div>
</ng-container>

<div *ngIf="isPreviewing && selectedVersionId" class="mt-4 p-3 border border-amber-300 bg-amber-50 text-amber-800 text-sm rounded">
  Previewing v{{ previewVersionNo }} - changes will not be saved
</div>

<app-image-picker-dialog
  [isOpen]="isImagePickerOpen"
  (closed)="closeImagePicker()"
  (confirmed)="applySelectedImage($event)">
</app-image-picker-dialog>

<div class="relative bg-cover bg-center bg-no-repeat text-white py-24 px-4" [style.background-image]="heroImageUrl ? 'url(' + heroImageUrl + ')' : null">
  <button
    *ngIf="isEditMode"
    type="button"
    class="absolute top-4 right-4 bg-black/50 text-white rounded-full p-2 hover:bg-black/70 transition"
    aria-label="Edit hero image"
    (click)="openImagePicker()"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path d="M4 13.5V16h2.5L15.7 6.8l-2.5-2.5L4 13.5zm12.7-7.2a1 1 0 0 0 0-1.4l-1.6-1.6a1 1 0 0 0-1.4 0l-1.3 1.3 2.5 2.5 1.8-1.8z"/>
    </svg>
  </button>
  <div class="bg-black/50 p-8 rounded-md max-w-3xl mx-auto text-center">
    <h1 class="text-4xl md:text-6xl font-heading font-normal">
      <ng-container *ngIf="isEditMode; else aboutTitleView">
        <textarea
          rows="1"
          class="w-full bg-transparent text-center outline-none resize-none"
          [(ngModel)]="heroTitle"
          (ngModelChange)="onHeadingChange($event)"></textarea>
      </ng-container>
      <ng-template #aboutTitleView>{{ heroTitle }}</ng-template>
    </h1>
  </div>
</div>

<div class="flex flex-col items-start gap-6 py-12 border-t border-gray-200">
  <div class="w-full space-y-4 font-body text-contrast">
    <ng-container *ngIf="isEditMode; else aboutIntroView">
      <app-editable-text-block [(content)]="introHtml" (contentChange)="onIntroChange($event)" [editable]="true"></app-editable-text-block>
    </ng-container>
    <ng-template #aboutIntroView>
      <div class="prose prose-neutral max-w-none" [innerHTML]="introHtml"></div>
    </ng-template>
  </div>
</div>

<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-heading font-normal text-brown-800">The People Behind the Vines</h2>
    <button
      *ngIf="isEditMode"
      type="button"
      class="bg-gray-200 text-gray-800 px-3 py-2 rounded hover:bg-gray-300 transition"
      (click)="addPerson()">
      + Add person
    </button>
  </div>

  <div class="space-y-6">
    <ng-container *ngFor="let person of peopleList; let i = index">
      <ng-container *ngIf="isEditMode || person.isActive !== false">
        <div *ngIf="editingPersonIndex !== i; else editPersonPanel" class="space-y-3" [class.opacity-60]="person.isActive === false">
          <div class="flex items-center justify-between">
            <h3 class="text-lg md:text-xl text-brown-900 font-medium">
              {{ person.name || 'Untitled person' }}
            </h3>
            <div *ngIf="isEditMode" class="flex items-center gap-2">
              <span *ngIf="person.isActive === false" class="text-xs uppercase tracking-wide text-amber-700">Removed</span>
              <button
                type="button"
                class="text-sm text-gray-700 hover:text-gray-900"
                [disabled]="i === 0"
                (click)="movePerson(i, 'up')">
                Up
              </button>
              <button
                type="button"
                class="text-sm text-gray-700 hover:text-gray-900"
                [disabled]="i === peopleList.length - 1"
                (click)="movePerson(i, 'down')">
                Down
              </button>
              <button
                type="button"
                class="text-sm text-gray-700 hover:text-gray-900"
                (click)="editPerson(i)">
                Edit
              </button>
              <button
                *ngIf="person.isActive !== false"
                type="button"
                class="text-sm text-red-600 hover:text-red-700"
                (click)="markPersonRemoved(i)">
                Remove
              </button>
              <button
                *ngIf="person.isActive === false"
                type="button"
                class="text-sm text-emerald-600 hover:text-emerald-700"
                (click)="restorePerson(i)">
                Restore
              </button>
            </div>
          </div>
          <div class="flex items-start gap-6">
            <img
              *ngIf="person.imageUrl"
              [src]="person.imageUrl"
              [alt]="person.name"
              class="w-[140px] h-[170px] md:w-[160px] md:h-[190px] object-cover rounded shadow shrink-0"
            />
            <p class="font-body text-contrast leading-relaxed">{{ person.text }}</p>
          </div>
        </div>
        <ng-template #editPersonPanel>
          <div class="border border-gray-200 rounded-lg p-4 space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-medium text-gray-900">Edit person</h3>
              <div class="flex items-center gap-2">
                <button
                  type="button"
                  class="text-sm text-gray-700 hover:text-gray-900"
                  [disabled]="i === 0"
                  (click)="movePerson(i, 'up')">
                  Up
                </button>
                <button
                  type="button"
                  class="text-sm text-gray-700 hover:text-gray-900"
                  [disabled]="i === peopleList.length - 1"
                  (click)="movePerson(i, 'down')">
                  Down
                </button>
                <button
                  type="button"
                  class="text-sm text-red-600 hover:text-red-700"
                  (click)="discardEditingPerson()">
                  Discard
                </button>
                <button
                  type="button"
                  class="text-sm text-emerald-600 hover:text-emerald-700"
                  (click)="publishEditingPerson()">
                  Close
                </button>
              </div>
            </div>

            <label class="block text-sm text-gray-700">
              Name
              <input
                type="text"
                class="mt-1 w-full border border-gray-300 rounded px-3 py-2"
                [(ngModel)]="person.name"
                (ngModelChange)="onPersonFieldChange()"
              />
            </label>

            <label class="block text-sm text-gray-700">
              Blurb
              <textarea
                rows="4"
                class="mt-1 w-full border border-gray-300 rounded px-3 py-2"
                [(ngModel)]="person.text"
                (ngModelChange)="onPersonFieldChange()"></textarea>
            </label>

            <div class="flex items-center gap-4">
              <div class="w-[120px] h-[150px] bg-gray-100 rounded flex items-center justify-center text-xs text-gray-500">
                <img *ngIf="person.imageUrl" [src]="person.imageUrl" [alt]="person.name" class="w-full h-full object-cover rounded" />
                <span *ngIf="!person.imageUrl">No image</span>
              </div>
              <button
                type="button"
                class="bg-gray-200 text-gray-800 px-3 py-2 rounded hover:bg-gray-300 transition"
                (click)="openPersonImagePicker(i)">
                Choose image
              </button>
            </div>

            <label class="block text-sm text-gray-700">
              Sort order
              <input
                type="number"
                min="1"
                class="mt-1 w-32 border border-gray-300 rounded px-3 py-2"
                [(ngModel)]="person.sortOrder"
                (ngModelChange)="onPersonFieldChange()"
              />
            </label>
          </div>
        </ng-template>
      </ng-container>
    </ng-container>
  </div>
</div>
