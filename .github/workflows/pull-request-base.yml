name: Pull Request Base

on:
  push:
    branches: [dev, staging]
  workflow_dispatch:
    inputs:
      target:
        description: Promotion target
        required: true
        type: choice
        options:
          - dev-to-staging
          - staging-to-main

permissions:
  contents: read
  pull-requests: write

jobs:
  promote-dev-to-staging:
    name: Promote Dev to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/dev') ||
      (github.event_name == 'workflow_dispatch' && inputs.target == 'dev-to-staging')
    steps:
      - uses: actions/checkout@v4
      - name: Generate or update promotion PR
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_BRANCH: staging
          HEAD_BRANCH: dev
          PR_TITLE: "Promote: dev → staging"
          PR_LABELS: promotion,automation,env:staging
        run: scripts/promotion-pr/generate-promotion-pr-body.sh

  promote-staging-to-main:
    name: Promote Staging to Main
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/staging') ||
      (github.event_name == 'workflow_dispatch' && inputs.target == 'staging-to-main')
    steps:
      - uses: actions/checkout@v4
      - name: Generate or update promotion PR
        env:
          GH_TOKEN: ${{ github.token }}
          BASE_BRANCH: main
          HEAD_BRANCH: staging
          PR_TITLE: "Release: staging → main"
          PR_LABELS: promotion,automation,env:prod,release
        run: scripts/promotion-pr/generate-promotion-pr-body.sh
